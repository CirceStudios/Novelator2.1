package com.novelator.autogen.util;

import java.io.IOException;
import java.util.List;

public class AuditorSistema {

    public static void ejecutarAuditoriaFinal() {
        System.out.println("\nüß™ Comprobando integridad del sistema tras la actualizaci√≥n...");

        boolean compilacionExitosa = testCompilacion();
        boolean clasesCargadas = testClasesCargadas();

        if (compilacionExitosa && clasesCargadas) {
            System.out.println("‚úÖ Sistema verificado. Todo parece en orden, capit√°n.");
        } else {
            System.out.println("‚ö†Ô∏è Problemas detectados durante la auditor√≠a final.");
        }
    }

    private static boolean testCompilacion() {
        System.out.println("üîß Ejecutando compilaci√≥n con 'javac'...");
        try {
            Process proceso = Runtime.getRuntime().exec("javac -d ./bin $(find ./src -name '*.java')");
            int exitCode = proceso.waitFor();
            return exitCode == 0;
        } catch (IOException | InterruptedException e) {
            System.err.println("‚ùå Error durante compilaci√≥n: " + e.getMessage());
            return false;
        }
    }

    private static boolean testClasesCargadas() {
        System.out.println("üì¶ Validando carga de clases generadas...");
        try {
            List<String> nuevas = FileUtils.listarArchivos("autogen-output/nuevas/", ".java");
            if (nuevas.isEmpty()) {
                System.out.println("‚ÑπÔ∏è No hay nuevas clases para validar carga.");
                return true;
            }

            for (String path : nuevas) {
                String className = extraerNombreClase(path);
                try {
                    Class.forName(className);
                    System.out.println("‚úÖ Clase cargada: " + className);
                } catch (ClassNotFoundException e) {
                    System.out.println("‚ùå No se pudo cargar: " + className);
                    return false;
                }
            }
            return true;
        } catch (Exception e) {
            System.out.println("‚ùå Error al validar clases nuevas: " + e.getMessage());
            return false;
        }
    }

    private static String extraerNombreClase(String filePath) {
        String nombre = filePath.replace("autogen-output/nuevas/", "")
                                .replace(".java", "")
                                .replace("/", ".");
        return "com.novelator." + nombre;
    }

}
